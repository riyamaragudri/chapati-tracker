<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hostel Chapati Tracker</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Tangerine:wght@400;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#9ad1f1,#f8c1dc);
    padding:20px;
}
.container {
    max-width:520px;
    margin:auto;
    background:#ffffffcc;
    padding:25px;
    border-radius:20px;
    box-shadow:0 8px 25px rgba(0,0,0,0.2);
    text-align:center;
}
button{
    padding:12px;margin:6px 0;width:100%;border:none;border-radius:10px;font-size:16px;cursor:pointer;
}
.yes{background:#6fcf97;}
.no{background:#f78da7;}
.admin{background:#b084cc;}

.editBtn{background:#ffd97d;font-size:12px;padding:4px 8px;border-radius:6px;margin-left:5px;}
.deleteBtn{background:#ff7b7b;font-size:12px;padding:4px 8px;border-radius:6px;margin-left:5px;}

.sectionBox{
    background:#f0f4f8;padding:12px;border-radius:12px;margin-top:15px;text-align:left;
}
.hidden{display:none;}
.lock{color:red;font-weight:bold;margin-top:10px;}

footer {
    position: fixed;
    bottom: 12px;
    right: 18px;
    font-size: 13px;
    font-style: italic;
    color: #666;
    opacity: 0.8;
}
</style>
</head>

<body>
<div class="container">

<h2>ğŸ½ï¸ Chapati Tracker</h2>
<div id="date"></div>
<div id="time"></div>

<button class="yes" onclick="eatYes()">I will eat chapati</button>
<button class="no" onclick="showInput()">I will NOT eat chapati</button>

<div id="nameBox" class="hidden">
    <input type="number" id="roomInput" placeholder="Room number">
    <input type="text" id="nameInput" placeholder="Your name">
    <button onclick="addNotEating()">Submit</button>
</div>

<div class="sectionBox">
    <b>ğŸ½ï¸ Eating Entries</b>
    <div id="eatingRooms"></div>
</div>

<div class="sectionBox">
    <b>âŒ Not Eating Entries</b>
    <div id="notEatingRooms"></div>
</div>

<button class="admin" onclick="adminLogin()">Admin Login</button>

<div id="adminPanel" class="hidden">
    <h3>ğŸ¥‘ Admin Panel</h3>

    <div class="sectionBox">
        <b>Total Chapatis:</b>
        <div id="totalChapati"></div>
    </div>

    <div class="sectionBox">
        <b>Room-wise:</b>
        <div id="roomWise"></div>
    </div>

    <div class="sectionBox">
        <b>Not Eating Names:</b>
        <div id="notEatingNames"></div>
    </div>

    <div class="sectionBox">
        <b>Total Not Eating:</b>
        <div id="totalNotEating"></div>
    </div>

    <button class="admin" onclick="toggleHistory()">ğŸ“š View Last 7 Days History</button>
    <div id="historyPanel" class="hidden sectionBox"></div>
</div>

<div id="lockMsg" class="lock"></div>
</div>

<script>
/* ğŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAEVSOiUNhsh_E8Oo5IcegjwqYs_MnF8ZY",
  authDomain: "hostel-chapati-tracker.firebaseapp.com",
  databaseURL: "https://hostel-chapati-tracker-default-rtdb.firebaseio.com",
  projectId: "hostel-chapati-tracker",
  storageBucket: "hostel-chapati-tracker.firebasestorage.app",
  messagingSenderId: "1033541076858",
  appId: "1:1033541076858:web:ad1c063a5e92c3f48678c3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* USER ID */
let userId = localStorage.getItem("chapatiUserId");
if(!userId){
    userId = "user_" + Math.random().toString(36).substr(2,9);
    localStorage.setItem("chapatiUserId", userId);
}

/* GLOBAL */
let isAdmin=false;
const ADMIN_PASSWORD="5678";
let dbData={};
    function eatingRoomExists(room){
    const eat = dbData.eating || {};
    for(let id in eat){
        if(eat[id].room === room) return true;
    }
    return false;
    }

/* â° LOCK TIME 6:30 PM */
function isLocked(){
    const now=new Date();
    const lock=new Date();
    lock.setHours(18,30,0);
    return now>=lock;
}

/* LIVE SYNC */
db.ref("today").on("value",snap=>{
    dbData = snap.val() || {eating:{}, not_eating:{}};
    updateUI();
});

/* âœ… DAILY RESET + HISTORY */
function dailyReset(){
    const todayStr = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

    db.ref("meta/date").once("value").then(snap=>{
        const lastDate = snap.val();

        if(lastDate !== todayStr){

            // save yesterday
            if(dbData){
                db.ref("history/"+lastDate).set(dbData);
            }

            // reset today
            db.ref("today").set({eating:{}, not_eating:{}});

            // update date
            db.ref("meta/date").set(todayStr);

            // clean >7 days
            cleanOldHistory();
        }
    });
}

/* âœ… CLEAN HISTORY */
function cleanOldHistory(){
    db.ref("history").once("value").then(snap=>{
        const historyData = snap.val() || {};
        const dates = Object.keys(historyData).sort(); // YYYY-MM-DD

        if(dates.length > 7){
            const toDelete = dates.slice(0, dates.length - 7);
            toDelete.forEach(d=>{
                db.ref("history/"+d).remove();
            });
        }
    });
}

/* EATING */
function eatYes(){
    if(isLocked()) return alert("Time up");

    const room = prompt("Room:");
    const count = prompt("Count:");

    if(!room || !count) return;

    const roomNo = parseInt(room);

    // â— Check only eating section
    if(eatingRoomExists(roomNo)){
        alert("âŒ This room already has an eating entry.");
        return;
    }

    db.ref("today/eating").push({
        room: roomNo,
        count: parseInt(count),
        owner: userId
    });
}

/* NOT EATING */
function showInput(){
    if(isLocked()) return;
    document.getElementById("nameBox").classList.remove("hidden");
}

function addNotEating(){
    const room=document.getElementById("roomInput").value;
    const name=document.getElementById("nameInput").value;
    if(!room||!name) return;
    db.ref("today/not_eating").push({
        room:parseInt(room),
        name,
        owner:userId
    });
    document.getElementById("nameBox").classList.add("hidden");
}

/* USER EDIT/DELETE */
function editEating(id){
    const item=dbData.eating[id];
    if(item.owner!==userId) return;
    const c=prompt("New count:",item.count);
    db.ref("today/eating/"+id+"/count").set(parseInt(c));
}

function deleteEating(id){
    if(dbData.eating[id].owner!==userId) return;
    db.ref("today/eating/"+id).remove();
}

function editNotEating(id){
    const item=dbData.not_eating[id];
    if(item.owner!==userId) return;
    const n=prompt("New name:",item.name);
    db.ref("today/not_eating/"+id+"/name").set(n);
}

function deleteNotEating(id){
    if(dbData.not_eating[id].owner!==userId) return;
    db.ref("today/not_eating/"+id).remove();
}

/* ADMIN */
function adminLogin(){
    const p=prompt("Admin password:");
    if(p===ADMIN_PASSWORD){
        isAdmin=true;
        document.getElementById("adminPanel").classList.remove("hidden");
        updateUI();
    }
}

/* HISTORY */
function toggleHistory(){
    const panel=document.getElementById("historyPanel");
    panel.classList.toggle("hidden");
    if(!panel.classList.contains("hidden")){
        loadHistory();
    }
}
function updateUI(){
    let eatingHtml="", notEatingHtml="";
    let total=0, notEat=0, names=[];

    /* ---------- EATING (SORTED BY ROOM, NO DUPLICATES) ---------- */
    const eat=dbData.eating||{};
    let roomArray = [];

    Object.keys(eat).forEach(id=>{
        roomArray.push({
            id,
            room: eat[id].room,
            count: eat[id].count,
            owner: eat[id].owner
        });
    });

    // sort room numbers
    roomArray.sort((a,b)=>a.room-b.room);

    roomArray.forEach(d=>{
        total += d.count;
        let btn="";
        if(d.owner===userId){
            btn=`<button class="editBtn" onclick="editEating('${d.id}')">âœï¸</button>
                 <button class="deleteBtn" onclick="deleteEating('${d.id}')">ğŸ—‘ï¸</button>`;
        }
        eatingHtml += `â¤ï¸ Room ${d.room}: ${d.count} ${btn}<br>`;
    });

    /* ---------- NOT EATING (UNCHANGED) ---------- */
    const ne=dbData.not_eating||{};
    Object.keys(ne).forEach(id=>{
        const d=ne[id];
        notEat++;
        names.push(d.name);
        let btn="";
        if(d.owner===userId){
            btn=`<button class="editBtn" onclick="editNotEating('${id}')">âœï¸</button>
                 <button class="deleteBtn" onclick="deleteNotEating('${id}')">ğŸ—‘ï¸</button>`;
        }
        notEatingHtml+=`âŒ Room ${d.room} - ${d.name} ${btn}<br>`;
    });

    document.getElementById("eatingRooms").innerHTML = eatingHtml || "No entries";
    document.getElementById("notEatingRooms").innerHTML = notEatingHtml || "No entries";

    if(isAdmin){
        document.getElementById("totalChapati").innerText=total;
        document.getElementById("roomWise").innerHTML=eatingHtml;
        document.getElementById("notEatingNames").innerHTML=names.join("<br>");
        document.getElementById("totalNotEating").innerText=notEat;
    }
}
function loadHistory(){
    db.ref("history").once("value").then(snap=>{
        const history=snap.val()||{};
        let html="";
        const dates=Object.keys(history).sort().reverse();

        dates.forEach(date=>{
            const day=history[date];
            let chap=0, notEat=0, names=[];

            if(day.eating){
                Object.values(day.eating).forEach(d=>{
                    chap+=d.count;
                });
            }

            if(day.not_eating){
                Object.values(day.not_eating).forEach(d=>{
                    notEat++;
                    names.push(d.name);
                });
            }

            html+=`
            <b>ğŸ“… ${date}</b><br>
            ğŸ½ï¸ Chapatis: ${chap}<br>
            âŒ Not Eating: ${notEat}<br>
            ğŸ‘¤ Names: ${names.join(", ")||"None"}<br>
            <hr>
            `;
        });

        document.getElementById("historyPanel").innerHTML = html || "No history";
    });
}

/* UI */


/* TIME */
function updateTime(){
    const n=new Date();
    document.getElementById("date").innerText="ğŸ“… "+n.toDateString();
    document.getElementById("time").innerText="ğŸ•’ "+n.toLocaleTimeString();
    document.getElementById("lockMsg").innerText=isLocked()?"ğŸ”’ Closed":"âœ… Open till 6:30 PM";
}

setInterval(updateTime,1000);
dailyReset();
updateTime();
</script>

<footer>ğŸ¾Crafted with care by RM</footer>
</body>
</html>
