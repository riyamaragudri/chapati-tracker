<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Hostel Chapati Tracker</title>

<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
body {
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#9ad1f1,#f8c1dc);
    padding:20px;
}
.container {
    max-width:500px;
    margin:auto;
    background:#ffffffcc;
    padding:25px;
    border-radius:20px;
    box-shadow:0 8px 25px rgba(0,0,0,0.2);
    text-align:center;
}
.datetime { font-size:14px; color:#555; margin-bottom:15px; }

button {
    padding:12px;
    margin:6px 0;
    width:100%;
    border:none;
    border-radius:10px;
    font-size:16px;
    cursor:pointer;
}
.yes { background:#6fcf97; }
.no { background:#f78da7; }
.admin { background:#b084cc; }

.editBtn{ background:#ffd97d; font-size:12px; padding:5px 10px; border-radius:6px; margin-left:5px; }
.deleteBtn{ background:#ff7b7b; font-size:12px; padding:5px 10px; border-radius:6px; margin-left:5px; }

input{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:6px;
    border:1px solid #ccc;
}

.sectionBox{
    background:#f0f4f8;
    padding:12px;
    border-radius:12px;
    margin-top:15px;
    text-align:left;
}
.hidden{display:none;}
.lock{color:red;font-weight:bold;margin-top:10px;}
</style>
</head>

<body>

<div class="container">
<h2>üçΩÔ∏è Chapati Tracker</h2>

<div class="datetime">
<div id="date"></div>
<div id="time"></div>
</div>

<button class="yes" onclick="eatYes()">I will eat chapati</button>
<button class="no" onclick="showInput()">I will NOT eat chapati</button>

<div id="nameBox" class="hidden">
<input type="number" id="roomInput" placeholder="Room number">
<input type="text" id="nameInput" placeholder="Your name">
<button onclick="addNotEating()">Submit</button>
</div>

<div class="sectionBox">
<b>üçΩÔ∏è Eating</b>
<div id="eatingRooms"></div>
</div>

<div class="sectionBox">
<b>‚ùå Not Eating</b>
<div id="notEatingRooms"></div>
</div>

<button class="admin" onclick="adminLogin()">Admin Login</button>

<div id="adminPanel" class="hidden">
<div class="sectionBox"><b>Total Chapatis:</b> <div id="totalChapati"></div></div>
<div class="sectionBox"><b>Room-wise Count:</b> <div id="roomWise"></div></div>
<div class="sectionBox"><b>Not Eating Names:</b> <div id="notEatingNames"></div></div>
<div class="sectionBox"><b>Total Not Eating:</b> <div id="totalNotEating"></div></div>
</div>

<div id="lockMsg" class="lock"></div>
</div>

<script>
/* üî• FIREBASE INIT */
const firebaseConfig = {
  apiKey: "AIzaSyAEVSOiUNhsh_E8Oo5IcegjwqYs_MnF8ZY",
  authDomain: "hostel-chapati-tracker.firebaseapp.com",
  databaseURL: "https://hostel-chapati-tracker-default-rtdb.firebaseio.com",
  projectId: "hostel-chapati-tracker",
  storageBucket: "hostel-chapati-tracker.firebasestorage.app",
  messagingSenderId: "1033541076858",
  appId: "1:1033541076858:web:ad1c063a5e92c3f48678c3",
  measurementId: "G-VB488DXLLG"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* üîê SETTINGS */
const ADMIN_PASSWORD = "5678";
let isAdmin = false;

/* ‚è∞ LOCK TIME = 7:30 PM */
function isLocked(){
    const now = new Date();
    const lockTime = new Date();
    lockTime.setHours(19,30,0);   // 7:30 PM
    return now >= lockTime;
}

/* üìÖ TODAY KEY */
function getTodayKey(){
    const d = new Date();
    return d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
}

const todayKey = getTodayKey();
const todayRef = db.ref("todayData/"+todayKey);
const historyRef = db.ref("history");

/* üîÑ AUTO DAILY RESET */
db.ref("meta/lastDate").once("value",snap=>{
    const last = snap.val();
    if(last !== todayKey){
        db.ref("todayData/"+last).once("value",s=>{
            if(s.exists()){
                historyRef.child(last).set(s.val());
            }
        });
        todayRef.remove();
        db.ref("meta/lastDate").set(todayKey);
    }
});

/* üçΩÔ∏è EATING */
function eatYes(){
    if(isLocked()) return alert("Time up üíó");
    const room = prompt("Room number:");
    const count = prompt("How many people?");
    if(!room || !count) return;
    todayRef.child("eating").child(room).set({
        room:Number(room),
        count:Number(count)
    });
}

/* ‚ùå NOT EATING */
function showInput(){
    if(isLocked()) return;
    document.getElementById("nameBox").classList.remove("hidden");
}

function addNotEating(){
    const room = roomInput.value;
    const name = nameInput.value;
    if(!room || !name) return;
    const id = Date.now();
    todayRef.child("not_eating").child(id).set({
        room:Number(room),
        name:name
    });
    roomInput.value="";
    nameInput.value="";
    nameBox.classList.add("hidden");
}

/* üëë ADMIN */
function adminLogin(){
    const pass = prompt("Admin password:");
    if(pass===ADMIN_PASSWORD){
        isAdmin=true;
        adminPanel.classList.remove("hidden");
    }else alert("Wrong password");
}

/* üî• REALTIME SYNC */
todayRef.on("value",snap=>{
    const data = snap.val() || {};
    const eating = data.eating || {};
    const notEating = data.not_eating || {};

    let eatHtml="", notHtml="";
    let totalChap=0, totalNot=0, names=[];

    Object.values(eating).sort((a,b)=>a.room-b.room).forEach(d=>{
        totalChap+=d.count;
        eatHtml+=`‚ù§Ô∏è Room ${d.room}: ${d.count}<br>`;
    });

    Object.values(notEating).sort((a,b)=>a.room-b.room).forEach(d=>{
        totalNot++;
        names.push(d.name);
        notHtml+=`‚ùå Room ${d.room} - ${d.name}<br>`;
    });

    eatingRooms.innerHTML = eatHtml || "No eating entries";
    notEatingRooms.innerHTML = notHtml || "No not eating entries";

    if(isAdmin){
        totalChapati.innerText = totalChap;
        roomWise.innerHTML = eatHtml || "No data";
        notEatingNames.innerHTML = names.join("<br>") || "No data";
        totalNotEating.innerText = totalNot;
    }
});

/* üïí TIME */
function updateDateTime(){
    const now=new Date();
    date.innerText="üìÖ "+now.toDateString();
    time.innerText="üïí "+now.toLocaleTimeString();
    lockMsg.innerText = isLocked() ? "üîí Submissions closed" : "‚úÖ Open till 7:30 PM";
}
setInterval(updateDateTime,1000);
updateDateTime();
</script>

</body>
</html>
